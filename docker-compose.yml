version: "3.8"

volumes:
  api-vscode-ext:

networks:
  rasa:

services:
  app:
    container_name: app
    image: rasa:base
    command: "run --enable-api" # --endpoints /data/endpoints.yml --credentials /data/credentials.yml"
    volumes:
      - ./rasa/app:/app
      - ./api/data:/data
    networks:
      - rasa
    ports:
      - 5005:5005

  action:
    container_name: action
    image: rasa-sdk:custom
    command: "start --actions actions --auto-reload"
    volumes:
      - ./rasa/app/actions:/app/actions
    networks:
      - rasa
    ports:
      - 5055:5055

  api:
    container_name: api
    image: asar-api:latest
    command:
      [
        "--reload",
        "--access-logfile=-",
        "--access-logformat='%({x-forwarded-for}i)s %(h)s %(l)s %(u)s %(t)s \"%(r)s\" %(s)s %(b)s \"%(f)s\" \"%(a)s\"'",
        "--log-level=debug",
        "--timeout=300",
        "--bind=0.0.0.0:5500",
        "asar_api:create_app()",
      ]
    volumes:
      - ./api/app:/app
      - ./api/data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      - api-vscode-ext:/root/.vscode-server/extensions
    environment:
      RASA_API_URL: http://app:5005
      ASAR_API_URL: http://api:5500
    networks:
      - rasa
    ports:
      - 5500:5500
    restart: unless-stopped

  tunnel:
    image: cloudflare/cloudflared:latest
    command: "tunnel --no-autoupdate run"
    environment:
      TUNNEL_TOKEN:
    networks:
      - rasa
    restart: unless-stopped

# docker run -it --rm --network rasa --net-alias rasa -p 5005:5005 -v ~/app:/app rasa:custom shell
# docker run -it --rm --network rasa --net-alias action -p 5055:5055 -v ~/app/actions:/app/actions rasa-sdk:custom start -v -vv --actions actions
# docker run -it --rm -v $(pwd)/rasa/app:/app rasa:base init
